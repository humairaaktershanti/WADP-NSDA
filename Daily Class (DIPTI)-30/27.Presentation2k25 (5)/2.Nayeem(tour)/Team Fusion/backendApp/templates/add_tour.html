{% extends 'backend_base.html' %}
{% load static %}

{% block title %}Add New Tour{% endblock %}

{% block content %}
<div class="container my-4">
   <div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="mb-4">Add New Tour</h2>
  <a href="{% url 'tour_list' %}" class="btn btn-primary">Tour Management</a>
   </div>

  <form method="post" action="{% url 'add_tour' %}" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="row g-3">

      <!-- Title -->
      <div class="col-12">
        <input type="text" name="title" class="form-control" placeholder="Tour Title" required>
      </div>

      <!-- Category / Country / City with modals -->
      <div class="col-4">
        <div class="input-group">
          <select name="category" class="form-select" required>
            <option value="">-- Select Category --</option>
            {% for category in categories %}
              <option value="{{ category.id }}">{{ category.name }}</option>
            {% endfor %}
          </select>
          <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addCategoryModal">+</button>
        </div>
      </div>

      <div class="col-4">
  <div class="input-group">
    <select name="country" id="countrySelect" class="form-select" required>
      <option value="">-- Select Country --</option>
      {% for country in countries %}
        <option value="{{ country.id }}">{{ country.name }}</option>
      {% endfor %}
    </select>
    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addCountryModal">+</button>
  </div>
</div>

<div class="col-4">
  <div class="input-group">
    <select name="city" id="citySelect" class="form-select" required>
      <option value="">-- Select City --</option>
      {% for city in cities %}
        <option value="{{ city.id }}" data-country="{{ city.country.id }}">{{ city.name }}</option>
      {% endfor %}
    </select>
        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addCityModal">+</button>
      </div>
    </div>
      <!-- Prices -->
      <div class="col-4">
        <input type="number" name="regular_price" step="0.01" class="form-control" placeholder="Regular Price" required>
      </div>
      <div class="col-4">
        <input type="number" name="offer_price" step="0.01" class="form-control" placeholder="Offer Price">
      </div>
      <div class="col-4">
        <input type="number" name="duration_days" class="form-control" placeholder="Duration (Days)">
      </div>

      <!-- Featured & Status -->
      <div class="col-6">
        <select name="is_featured" class="form-select">
          <option value="True" selected>Featured</option>
          <option value="False">Not Featured</option>
        </select>
      </div>
      <div class="col-6">
        <select name="is_active" class="form-select">
          <option value="True" selected>Active</option>
          <option value="False">Inactive</option>
        </select>
      </div>

      <!-- Featured Image -->
      <div class="col-6">
        <input type="file" name="tour_featured_image" class="form-control">
      </div>

      <!-- Multi Images -->
      <div class="col-6">
        <input type="file" name="tour_images" class="form-control" multiple>
      </div>

      <!-- Description -->
      <div class="col-12">
        <textarea name="description" class="form-control" rows="3" placeholder="Description"></textarea>
      </div>

      <!-- Submit Button -->
      <div class="col-12 text-end">
        <button type="submit" class="btn btn-success">Add Tour</button>
      </div>

    </div>
  </form>
</div>

<!-- Modals -->

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{% url 'add_category' %}" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Add New Category</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" name="name" class="form-control mb-2" placeholder="Category Name" required>
          <input type="file" name="catalog_image" class="form-control mb-2">
          <select name="is_active" class="form-select">
            <option value="True" selected>Active</option>
            <option value="False">Inactive</option>
          </select>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Category</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Country Modal -->
<div class="modal fade" id="addCountryModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{% url 'add_country' %}" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Add New Country</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" name="name" class="form-control mb-2" placeholder="Country Name" required>
          <input type="file" name="catalog_image" class="form-control mb-2">
          <select name="is_active" class="form-select">
            <option value="True" selected>Active</option>
            <option value="False">Inactive</option>
          </select>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Country</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add City Modal -->
<div class="modal fade" id="addCityModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{% url 'add_city' %}" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Add New City</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" name="name" class="form-control mb-2" placeholder="City Name" required>
          <select name="country" class="form-select mb-2" required>
            {% for country in countries %}
              <option value="{{ country.id }}">{{ country.name }}</option>
            {% endfor %}
          </select>
          <input type="file" name="catalog_image" class="form-control mb-2">
          <select name="is_active" class="form-select">
            <option value="True" selected>Active</option>
            <option value="False">Inactive</option>
          </select>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add City</button>
        </div>
      </form>
    </div>
  </div>
</div>



<script>
  const countrySelect = document.getElementById('countrySelect');
  const citySelect = document.getElementById('citySelect');

  countrySelect.addEventListener('change', function () {
      const selectedCountry = this.value;

      Array.from(citySelect.options).forEach(option => {
          if (!option.dataset.country) return; // skip placeholder
          option.style.display = (option.dataset.country === selectedCountry) ? 'block' : 'none';
      });

      citySelect.value = ""; // Reset city
  });

  // Initially hide all cities
  Array.from(citySelect.options).forEach(option => {
      if (!option.dataset.country) return;
      option.style.display = 'none';
  });
</script>
{% endblock %}
