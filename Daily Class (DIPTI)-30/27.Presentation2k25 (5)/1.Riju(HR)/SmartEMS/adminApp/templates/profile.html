{% extends "master/base.html" %}
{% load static %}

{% block content %}
<div class="page-wrapper">
    <div class="content container-fluid">

        <!-- Page Header -->
        <div class="page-header">
            <div class="row">
                <div class="col-sm-12">
                    <h3 class="page-title">Profile</h3>
                    <ul class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                        <li class="breadcrumb-item active">Profile</li>
                    </ul>
                </div>
            </div>
        </div>
        <!-- /Page Header -->

        <div class="card mb-0">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-12">
                        <div class="profile-view">

                            <!-- Profile Image -->
                            <div class="profile-img-wrap">
                                <div class="profile-img">
                                    <a href="#">
                                        <img 
                                            src="{% if request.user.profile.profile_image %}{{ request.user.profile.profile_image.url }}{% elif request.user.get_full_name %}https://avatar.iran.liara.run/username?username={{ request.user.get_full_name|urlencode }}{% else %}https://avatar.iran.liara.run/username?username={{ request.user.username|urlencode }}{% endif %}" 
                                            alt="User Image"
                                            style="width: 100px; height: 100px; border-radius: 50%;"
                                        >
                                    </a>
                                </div>
                            </div>

                            <div class="profile-basic">
                                <div class="row">
                                    <div class="col-md-5">
                                        <div class="profile-info-left">
                                            <h3 class="user-name m-t-0 mb-0">{{ request.user.profile.full_name }}</h3>
                                            <h6 class="text-muted">{% if request.user.profile.position %}{{ request.user.profile.position.title }}{% endif %}</h6>
                                            <small class="text-muted">{% if request.user.profile.position and request.user.profile.position.department %}{{ request.user.profile.position.department.name }}{% endif %}</small>
                                            
                                            <div class="staff-id">Employee ID : {{ request.user.profile.employee_id }}</div>
                                            <div class="small doj text-muted">Date of Join : {{ request.user.profile.date_of_joining }}</div>

                                            <!-- Show Team Role if available -->
                                            {% if team_member %}
                                            <div class="mt-2">
                                                <span class="badge 
                                                    {% if team_member.role == 'Lead' %} bg-success 
                                                    {% else %} bg-info {% endif %}">
                                                    Team Role: {{ team_member.role }}
                                                </span>
                                                <div class="text-muted mt-1">
                                                    Team: {{ team_member.team.name }}
                                                </div>
                                            </div>
                                            {% endif %}

                                            <div class="staff-msg"><a class="btn btn-custom" href="#">Send Message</a></div>
                                        </div>
                                    </div>

                                    <div class="col-md-7">
                                        <ul class="personal-info">
                                            <li>
                                                <div class="title">Phone:</div>
                                                <div class="text"><a href="tel:{{ request.user.profile.phone }}">{{ request.user.profile.phone }}</a></div>
                                            </li>
                                            <li>
                                                <div class="title">Email:</div>
                                                {% if request.user.user_types != 'Admin' %}
                                                <div class="text"><a href="mailto:{{ request.user.email }}">{{ request.user.email }}</a></div>
                                                {% elif request.user.user_types == 'Admin' %}
                                                <div class="text"><a href="mailto:{{ request.user.username }}">{{ request.user.username }}</a></div>
                                                {% endif %}
                                            </li>
                                            <li>
                                                <div class="title">Birthday:</div>
                                                <div class="text">{{ request.user.profile.birthday }}</div>
                                            </li>
                                            <li>
                                                <div class="title">Address:</div>
                                                <div class="text">{{ request.user.profile.address }}</div>
                                            </li>
                                            <li>
                                                <div class="title">Gender:</div>
                                                <div class="text">{{ request.user.profile.gender|capfirst }}</div>
                                            </li>
                                            {% if request.user.user_types != 'Admin' %}
                                            {% if request.user.profile.reports_to %}
                                            <li>
                                                <div class="title">Reports to:</div>
                                                <div class="text">
                                                    <div class="avatar-box d-inline-block">
                                                        <div class="avatar avatar-xs">
                                                            <a href="#" data-bs-toggle="modal" data-bs-target="#reportsToModal">
                                                                <img 
                                                                    src="{% if request.user.profile.reports_to.profile_image %}{{ request.user.profile.reports_to.profile_image.url }}{% elif request.user.profile.reports_to.full_name %}https://avatar.iran.liara.run/username?username={{ request.user.profile.reports_to.full_name|urlencode }}{% else %}https://avatar.iran.liara.run/username?username={{ request.user.profile.reports_to.user.username|urlencode }}{% endif %}" 
                                                                    alt="User Image"
                                                                    style="width: 24px; height: 24px; border-radius: 50%;"
                                                                >
                                                            </a>
                                                        </div>
                                                    </div>
                                                    <a href="#" data-bs-toggle="modal" data-bs-target="#reportsToModal">{{ request.user.profile.reports_to.full_name }}</a>
                                                </div>
                                            </li>
                                            {% endif %}
                                            {% endif %}
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div class="pro-edit">
                                <a class="edit-icon" href="{% url 'update_profile' %}"><i class="fa-solid fa-pencil"></i></a>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- Role update form (only visible to admins / leads) -->
                {% if team_member %}
                    {% if request.user.user_types == 'Admin' or is_team_lead %}
                        <div class="mt-4">
                            <form method="post" action="{% url 'update_team_member_role' team_member.id %}">
                                {% csrf_token %}
                                <label for="role">Update Role</label>
                                <select name="role" class="form-select" id="role">
                                    <option value="Lead" {% if team_member.role == 'Lead' %}selected{% endif %}>Lead</option>
                                    <option value="Member" {% if team_member.role == 'Member' %}selected{% endif %}>Member</option>
                                </select>
                                <button type="submit" class="btn btn-success mt-2">Update Role</button>
                            </form>
                        </div>
                    {% endif %}
                {% endif %}

            </div>
        </div>
    </div>
</div>

<!-- Reports To Modal -->
{% if request.user.profile.reports_to %}
<div class="modal fade" id="reportsToModal" tabindex="-1" aria-labelledby="reportsToModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reportsToModalLabel">{{ request.user.profile.reports_to.full_name }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img 
            src="{% if request.user.profile.reports_to.profile_image %}{{ request.user.profile.reports_to.profile_image.url }}{% else %}https://avatar.iran.liara.run/username?username={{ request.user.profile.reports_to.full_name|urlencode }}{% endif %}" 
            alt="User Image"
            class="img-fluid rounded-circle mb-3"
            style="width: 100px; height: 100px; object-fit: cover;"
        >
        <p><strong>Position:</strong> {% if request.user.profile.reports_to.position %}{{ request.user.profile.reports_to.position.title }}{% endif %}</p>
        <p><strong>Department:</strong> {% if request.user.profile.reports_to.position and request.user.profile.reports_to.position.department %}{{ request.user.profile.reports_to.position.department.name }}{% endif %}</p>
        <p><strong>Email:</strong> <a href="mailto:{{ request.user.profile.reports_to.user.email }}">{{ request.user.profile.reports_to.user.email }}</a></p>
        <p><strong>Phone:</strong> {{ request.user.profile.reports_to.phone }}</p>
        <p><strong>Birthday:</strong> {{ request.user.profile.reports_to.birthday }}</p>
        <p><strong>Gender:</strong> {{ request.user.profile.reports_to.gender|capfirst }}</p>
        <p><strong>Date of Joining:</strong> {{ request.user.profile.reports_to.date_of_joining }}</p>
        <p><strong>Address:</strong> {{ request.user.profile.reports_to.address }}</p>
      </div>
    </div>
  </div>
</div>
{% endif %}
{% endblock content %}

