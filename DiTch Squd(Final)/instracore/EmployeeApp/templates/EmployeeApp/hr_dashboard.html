{% extends "master.html" %}
{% block title %}HR Dashboard{% endblock title %}

{% block extra_css %}
<style>
    .main-content { position: static !important; z-index: auto !important; }
    .modal { z-index: 1060 !important; }
    .modal-backdrop { z-index: 1055 !important; }
    
    .dashboard-cards {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
    }
    
    .card {
        border-radius: 12px;
        border: 1px solid #f0f0f0;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
    }
    
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
    }
    
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .card-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--dark-gray);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .card-icon {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }
    
    .card-icon.primary {
        background: linear-gradient(135deg, rgba(74, 107, 223, 0.1), rgba(108, 99, 255, 0.1));
        color: var(--primary-color);
    }
    
    .card-icon.success {
        background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(25, 135, 84, 0.1));
        color: #28a745;
    }
    
    .card-icon.warning {
        background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(255, 152, 0, 0.1));
        color: #ffc107;
    }
    
    .card-icon.danger {
        background: linear-gradient(135deg, rgba(220, 53, 69, 0.1), rgba(214, 51, 132, 0.1));
        color: #dc3545;
    }
    
    .card-value {
        font-size: 2.4rem;
        font-weight: 700;
        margin-bottom: 10px;
        background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
    }
    
    .card-change {
        font-size: 0.9rem;
        color: var(--dark-gray);
        display: flex;
        align-items: center;
    }
    
    .card-change i {
        margin-right: 5px;
    }
    
    .card-change.positive {
        color: #28a745;
    }
    
    .card-change.negative {
        color: #dc3545;
    }
    
    .list-group-item {
        border: none;
        border-bottom: 1px solid #f1f1f1;
        padding: 0.6rem 0.8rem;
    }
    
    .list-group-item:last-child {
        border-bottom: none;
    }
    
    .calendar-container {
        position: relative;
        width: 100%;
    }
    
    .calendar-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .calendar-table th,
    .calendar-table td {
        padding: 8px;
        text-align: center;
        border: 1px solid #eee;
    }
    
    .calendar-table th {
        background-color: var(--primary-color);
        color: white;
    }
    
    .calendar-table .weekend {
        background-color: #fff3cd;
    }
    
    .calendar-table .holiday {
        background-color: #f8d7da;
    }
    
    .calendar-table .today {
        background-color: #d1ecf1;
        font-weight: bold;
    }
    
    .chart-container {
        position: relative;
        width: 100%;
        height: 300px;
    }
</style>
{% endblock extra_css %}

{% block content %}
<div class="page-header">
    <h1>HR Dashboard</h1>
    <p>Welcome back! Here's what's happening with your HR department today.</p>
</div>

<!-- Summary Cards -->
<div class="dashboard-cards">
    <div class="card">
        <div class="card-header">
            <div class="card-title">Total Employees</div>
            <div class="card-icon primary">
                <i class="fas fa-users"></i>
            </div>
        </div>
        <div class="card-value">{{ summary_data.employees.total }}</div>
        <div class="card-change positive">
            <i class="fas fa-arrow-up"></i> {{ summary_data.employees.active }} Active
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <div class="card-title">Active Job Posts</div>
            <div class="card-icon success">
                <i class="fas fa-briefcase"></i>
            </div>
        </div>
        <div class="card-value">{{ summary_data.job_posts.total }}</div>
        <div class="card-change positive">
            <i class="fas fa-arrow-up"></i> {{ summary_data.job_posts.active }} Active
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <div class="card-title">Applications</div>
            <div class="card-icon warning">
                <i class="fas fa-file-alt"></i>
            </div>
        </div>
        <div class="card-value">{{ summary_data.applications.total }}</div>
        <div class="card-change positive">
            <i class="fas fa-arrow-up"></i> {{ summary_data.applications.active }} Total
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <div class="card-title">Scheduled Interviews</div>
            <div class="card-icon danger">
                <i class="fas fa-calendar-check"></i>
            </div>
        </div>
        <div class="card-value">{{ summary_data.interviews.total }}</div>
        <div class="card-change positive">
            <i class="fas fa-arrow-up"></i> {{ summary_data.interviews.active }} Scheduled
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="card mb-4">
    <div class="card-header">
        <h3 class="card-title">Quick Actions</h3>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3 mb-3">
                <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#createJobPostModal">
                    <i class="fas fa-plus me-2"></i> Create Job Post
                </button>
            </div>
            <div class="col-md-3 mb-3">
                <button class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#createEmployeeModal">
                    <i class="fas fa-user-plus me-2"></i> Create Employee
                </button>
            </div>
            <div class="col-md-3 mb-3">
                <button class="btn btn-info w-100" data-bs-toggle="modal" data-bs-target="#interviewListModal">
                    <i class="fas fa-calendar me-2"></i> Manage Interviews
                </button>
            </div>
            <div class="col-md-3 mb-3">
                <button class="btn btn-warning w-100" data-bs-toggle="modal" data-bs-target="#applicationListModal">
                    <i class="fas fa-file-alt me-2"></i> View Applications
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <!-- Applications by Job Post -->
    <div class="col-md-6">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i> Applications by Job Post</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="applicationsByJobChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Employee Distribution -->
    <div class="col-md-6">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i> Employee Distribution</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="employeeDistributionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activities and Upcoming Interviews Row -->
<div class="row mb-4">
    <!-- Recent Activities -->
    <div class="col-md-6">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i> Recent Activities</h5>
                <button class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#allActivitiesModal">View All</button>
            </div>
            <div class="card-body p-2">
                <ul class="list-group list-group-flush">
                    {% for activity in recent_activities %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>{{ activity.first_name }} {{ activity.last_name }} joined as {{ activity.sub_role|title }}</span>
                        <span class="badge bg-secondary">{{ activity.date_joined|timesince }} ago</span>
                    </li>
                    {% empty %}
                    <li class="list-group-item text-muted">No recent activities</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <!-- Upcoming Interviews -->
    <div class="col-md-6">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i> Upcoming Interviews</h5>
                <button class="btn btn-sm btn-dark" data-bs-toggle="modal" data-bs-target="#allInterviewsModal">View All</button>
            </div>
            <div class="card-body p-2">
                <ul class="list-group list-group-flush">
                    {% for interview in upcoming_interviews %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ interview.application.applicant_name }}</strong>
                            <div class="text-muted small">{{ interview.application.job.title }}</div>
                        </div>
                        <span class="badge bg-primary">{{ interview.scheduled_date|date:"M d, H:i" }}</span>
                    </li>
                    {% empty %}
                    <li class="list-group-item text-muted">No upcoming interviews</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Calendar Row -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">Calendar</h3>
                <div class="d-flex">
                    <button class="btn btn-sm btn-outline-primary me-2" id="prevMonth">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <h4 class="mb-0" id="currentMonth">{{ calendar_data.month_name }} {{ calendar_data.year }}</h4>
                    <button class="btn btn-sm btn-outline-primary ms-2" id="nextMonth">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="calendar-container">
                    <table class="calendar-table">
                        <thead>
                            <tr>
                                <th>Sat</th>
                                <th>Sun</th>
                                <th>Mon</th>
                                <th>Tue</th>
                                <th>Wed</th>
                                <th>Thu</th>
                                <th>Fri</th>
                            </tr>
                        </thead>
                        <tbody id="calendarBody">
                            {% for week in calendar_data.calendar %}
                            <tr>
                                {% for day in week %}
                                <td class="{% if day == 0 %}empty{% else %}{% if day in calendar_data.weekends %}weekend{% endif %}{% if day == now.day %}today{% endif %}{% endif %}">
                                    {% if day != 0 %}{{ day }}{% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="mt-3">
                    <div class="d-flex align-items-center me-3">
                        <div class="bg-warning p-1 me-2" style="width: 20px; height: 20px;"></div>
                        <span>Weekend (Friday)</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="bg-danger p-1 me-2" style="width: 20px; height: 20px;"></div>
                        <span>Government Holiday</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export Data Section -->
<div class="card mb-4">
    <div class="card-header">
        <h3 class="card-title">Export Data</h3>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3 mb-3">
                <a href="{% url 'employee:export_employee_data' %}" class="btn btn-outline-primary w-100">
                    <i class="fas fa-download me-2"></i> Employee Data
                </a>
            </div>
            <div class="col-md-3 mb-3">
                <a href="{% url 'employee:export_job_data' %}" class="btn btn-outline-success w-100">
                    <i class="fas fa-download me-2"></i> Job Post Data
                </a>
            </div>
            <div class="col-md-3 mb-3">
                <a href="{% url 'employee:export_application_data' %}" class="btn btn-outline-warning w-100">
                    <i class="fas fa-download me-2"></i> Application Data
                </a>
            </div>
            <div class="col-md-3 mb-3">
                <button class="btn btn-outline-info w-100" data-bs-toggle="modal" data-bs-target="#userListModal">
                    <i class="fas fa-users me-2"></i> Manage Users
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Create Job Post Modal -->
<div class="modal fade" id="createJobPostModal" tabindex="-1" aria-labelledby="createJobPostModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createJobPostModalLabel">Create New Job Post</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="createJobPostForm" method="post" action="{% url 'employee:jobpost_create' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="jobTitle" class="form-label">Job Title</label>
                            <input type="text" class="form-control" id="jobTitle" name="title" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="jobRole" class="form-label">Role</label>
                            <select class="form-select" id="jobRole" name="role" required>
                                <option value="">Select a role</option>
                                <option value="admin">Admin</option>
                                <option value="employee">Employee</option>
                                <option value="faculty">Faculty</option>
                                <option value="hr">HR</option>
                                <option value="finance">Finance</option>
                                <option value="marketing">Marketing</option>
                                <option value="it">IT</option>
                                <option value="teacher">Teacher</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="jobSalary" class="form-label">Salary Range</label>
                            <input type="text" class="form-control" id="jobSalary" name="salary_range" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="jobLocation" class="form-label">Location</label>
                            <input type="text" class="form-control" id="jobLocation" name="location" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="jobLanguage" class="form-label">Language</label>
                            <input type="text" class="form-control" id="jobLanguage" name="language" value="English" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="jobDeadline" class="form-label">Application Deadline</label>
                            <input type="date" class="form-control" id="jobDeadline" name="deadline" required>
                        </div>
                        <div class="col-12 mb-3">
                            <label for="jobDescription" class="form-label">Job Description</label>
                            <textarea class="form-control" id="jobDescription" name="description" rows="3" required></textarea>
                        </div>
                        <div class="col-12 mb-3">
                            <label for="jobRequirements" class="form-label">Minimum Requirements</label>
                            <textarea class="form-control" id="jobRequirements" name="min_requirements" rows="3" required></textarea>
                        </div>
                        <div class="col-12 mb-3">
                            <label for="jobAvailability" class="form-label">Availability</label>
                            <input type="text" class="form-control" id="jobAvailability" name="availability" required>
                        </div>
                        <div class="col-12 mb-3">
                            <label for="jobInstructions" class="form-label">Application Instructions</label>
                            <textarea class="form-control" id="jobInstructions" name="application_instructions" rows="3" required></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Job Post</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create Employee Modal -->
<div class="modal fade" id="createEmployeeModal" tabindex="-1" aria-labelledby="createEmployeeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createEmployeeModalLabel">Create New Employee</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="createEmployeeForm" method="post" action="{% url 'employee:user_create' %}">
                {% csrf_token %}
                <input type="hidden" name="role" value="employee">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="employeeUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="employeeUsername" name="username" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="employeeEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="employeeEmail" name="email" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="employeePassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="employeePassword" name="password1" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="employeeConfirmPassword" class="form-label">Confirm Password</label>
                            <input type="password" class="form-control" id="employeeConfirmPassword" name="password2" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="employeeFirstName" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="employeeFirstName" name="first_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="employeeLastName" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="employeeLastName" name="last_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="employeeSubRole" class="form-label">Sub Role</label>
                            <select class="form-select" id="employeeSubRole" name="sub_role" required>
                                <option value="">Select a sub role</option>
                                <option value="faculty">Faculty</option>
                                <option value="hr">HR</option>
                                <option value="finance">Finance</option>
                                <option value="marketing">Marketing</option>
                                <option value="it">IT</option>
                                <option value="teacher">Teacher</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="employeeDOB" class="form-label">Date of Birth</label>
                            <input type="date" class="form-control" id="employeeDOB" name="date_of_birth">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="employeePhone" class="form-label">Phone</label>
                            <input type="text" class="form-control" id="employeePhone" name="phone">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="employeeGender" class="form-label">Gender</label>
                            <input type="text" class="form-control" id="employeeGender" name="gender">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="employeeLocation" class="form-label">Location</label>
                            <input type="text" class="form-control" id="employeeLocation" name="location">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="employeeCountry" class="form-label">Country</label>
                            <input type="text" class="form-control" id="employeeCountry" name="country">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Create Employee</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- User List Modal -->
<div class="modal fade" id="userListModal" tabindex="-1" aria-labelledby="userListModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="userListModalLabel">Manage Users</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Filter Users</h5>
                        <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#createEmployeeModal" data-bs-dismiss="modal">
                            <i class="fas fa-plus me-1"></i> Add New
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <select class="form-select" id="userRoleFilter">
                                    <option value="">All Roles</option>
                                    <option value="employee">Employee</option>
                                    <option value="candidate">Candidate</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <select class="form-select" id="userSubRoleFilter">
                                    <option value="">All Sub Roles</option>
                                    <option value="faculty">Faculty</option>
                                    <option value="hr">HR</option>
                                    <option value="finance">Finance</option>
                                    <option value="marketing">Marketing</option>
                                    <option value="it">IT</option>
                                    <option value="teacher">Teacher</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <input type="text" class="form-control" placeholder="Search users..." id="userSearch">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Sub Role</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            {% for user in users %}
                            <tr>
                                <td>{{ user.id }}</td>
                                <td>{{ user.username }}</td>
                                <td>{{ user.email }}</td>
                                <td>{{ user.role }}</td>
                                <td>{{ user.sub_role }}</td>
                                <td>
                                    {% if user.is_active %}
                                        <span class="badge bg-success">Active</span>
                                    {% else %}
                                        <span class="badge bg-danger">Inactive</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#updateUserModal{{ user.id }}">
                                        Update
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="confirmDelete({{ user.id }})">
                                        Delete
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Update Modals -->
{% for user in users %}
<div class="modal fade" id="updateUserModal{{ user.id }}" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" action="{% url 'employee:user_update' user.id %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Update User: {{ user.username }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" name="username" value="{{ user.username }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" value="{{ user.email }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">First Name</label>
                            <input type="text" class="form-control" name="first_name" value="{{ user.first_name }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Last Name</label>
                            <input type="text" class="form-control" name="last_name" value="{{ user.last_name }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Role</label>
                            <select class="form-select" name="role">
                                <option value="employee" {% if user.role == 'employee' %}selected{% endif %}>Employee</option>
                                <option value="candidate" {% if user.role == 'candidate' %}selected{% endif %}>Candidate</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Sub Role</label>
                            <select class="form-select" name="sub_role">
                                <option value="">Select a sub role</option>
                                <option value="faculty" {% if user.sub_role == 'faculty' %}selected{% endif %}>Faculty</option>
                                <option value="hr" {% if user.sub_role == 'hr' %}selected{% endif %}>HR</option>
                                <option value="finance" {% if user.sub_role == 'finance' %}selected{% endif %}>Finance</option>
                                <option value="marketing" {% if user.sub_role == 'marketing' %}selected{% endif %}>Marketing</option>
                                <option value="it" {% if user.sub_role == 'it' %}selected{% endif %}>IT</option>
                                <option value="teacher" {% if user.sub_role == 'teacher' %}selected{% endif %}>Teacher</option>
                                <option value="other" {% if user.sub_role == 'other' %}selected{% endif %}>Other</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Date of Birth</label>
                            <input type="date" class="form-control" name="date_of_birth" value="{{ user.date_of_birth|date:'Y-m-d' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Phone</label>
                            <input type="text" class="form-control" name="phone" value="{{ user.phone }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Gender</label>
                            <input type="text" class="form-control" name="gender" value="{{ user.gender }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Location</label>
                            <input type="text" class="form-control" name="location" value="{{ user.location }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Country</label>
                            <input type="text" class="form-control" name="country" value="{{ user.country }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" name="password1">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Confirm Password</label>
                            <input type="password" class="form-control" name="password2">
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_active" id="isActive{{ user.id }}" {% if user.is_active %}checked{% endif %}>
                                <label class="form-check-label" for="isActive{{ user.id }}">
                                    Active
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Update</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<!-- Interview List Modal -->
<div class="modal fade" id="interviewListModal" tabindex="-1" aria-labelledby="interviewListModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="interviewListModalLabel">Manage Interviews</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Filter Interviews</h5>
                        <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#createInterviewModal" data-bs-dismiss="modal">
                            <i class="fas fa-plus me-1"></i> Schedule New
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <select class="form-select" id="interviewStatusFilter">
                                    <option value="">All Statuses</option>
                                    <option value="scheduled">Scheduled</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <input type="text" class="form-control" placeholder="Search interviews..." id="interviewSearch">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Applicant</th>
                                <th>Job Position</th>
                                <th>Scheduled Date</th>
                                <th>Interviewer</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="interviewTableBody">
                            {% for interview in interviews %}
                            <tr>
                                <td>{{ interview.application.applicant_name }}</td>
                                <td>{{ interview.application.job.title }}</td>
                                <td>{{ interview.scheduled_date|date:"Y-m-d H:i" }}</td>
                                <td>{{ interview.interviewer.first_name }} {{ interview.interviewer.last_name }}</td>
                                <td>
                                    <span class="badge 
                                        {% if interview.status == 'scheduled' %}bg-primary
                                        {% elif interview.status == 'completed' %}bg-success
                                        {% elif interview.status == 'cancelled' %}bg-danger
                                        {% endif %}">
                                        {{ interview.status|title }}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#updateInterviewModal{{ interview.id }}">
                                        Update
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Interview Modal -->
<div class="modal fade" id="createInterviewModal" tabindex="-1" aria-labelledby="createInterviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createInterviewModalLabel">Schedule New Interview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="createInterviewForm" method="post" action="{% url 'employee:interview_create' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="interviewApplication" class="form-label">Application</label>
                            <select class="form-select" id="interviewApplication" name="application" required>
                                <option value="">Select an application</option>
                                {% for application in applications %}
                                <option value="{{ application.id }}">{{ application.applicant_name }} - {{ application.job.title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="interviewDate" class="form-label">Scheduled Date</label>
                            <input type="datetime-local" class="form-control" id="interviewDate" name="scheduled_date" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="interviewer" class="form-label">Interviewer</label>
                            <select class="form-select" id="interviewer" name="interviewer" required>
                                <option value="">Select an interviewer</option>
                                {% for user in users %}
                                    {% if user.sub_role == 'hr' %}
                                    <option value="{{ user.id }}">{{ user.first_name }} {{ user.last_name }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="interviewStatus" class="form-label">Status</label>
                            <select class="form-select" id="interviewStatus" name="status" required>
                                <option value="scheduled">Scheduled</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="col-12 mb-3">
                            <label for="interviewNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="interviewNotes" name="notes" rows="3"></textarea>
                        </div>
                        <div class="col-12 mb-3">
                            <label for="interviewFeedback" class="form-label">Feedback</label>
                            <textarea class="form-control" id="interviewFeedback" name="feedback" rows="3"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-info">Schedule Interview</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Interview Update Modals -->
{% for interview in interviews %}
<div class="modal fade" id="updateInterviewModal{{ interview.id }}" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" action="{% url 'employee:interview_update' interview.id %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Update Interview: {{ interview.application.applicant_name }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Application</label>
                            <select class="form-select" name="application" required>
                                <option value="">Select an application</option>
                                {% for application in applications %}
                                <option value="{{ application.id }}" {% if application.id == interview.application.id %}selected{% endif %}>{{ application.applicant_name }} - {{ application.job.title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Scheduled Date</label>
                            <input type="datetime-local" class="form-control" name="scheduled_date" value="{{ interview.scheduled_date|date:'Y-m-d\TH:i' }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Interviewer</label>
                            <select class="form-select" name="interviewer" required>
                                <option value="">Select an interviewer</option>
                                {% for user in users %}
                                    {% if user.sub_role == 'hr' %}
                                    <option value="{{ user.id }}" {% if user.id == interview.interviewer.id %}selected{% endif %}>{{ user.first_name }} {{ user.last_name }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" name="status" required>
                                <option value="scheduled" {% if interview.status == 'scheduled' %}selected{% endif %}>Scheduled</option>
                                <option value="completed" {% if interview.status == 'completed' %}selected{% endif %}>Completed</option>
                                <option value="cancelled" {% if interview.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                            </select>
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control" name="notes" rows="3">{{ interview.notes }}</textarea>
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Feedback</label>
                            <textarea class="form-control" name="feedback" rows="3">{{ interview.feedback }}</textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Update Interview</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<!-- Application List Modal -->
<div class="modal fade" id="applicationListModal" tabindex="-1" aria-labelledby="applicationListModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="applicationListModalLabel">View Applications</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Filter Applications</h5>
                        <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#createInterviewModal" data-bs-dismiss="modal">
                            <i class="fas fa-calendar-plus me-1"></i> Schedule Interview
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <select class="form-select" id="applicationJobFilter">
                                    <option value="">All Jobs</option>
                                    {% for job in job_posts %}
                                    <option value="{{ job.id }}">{{ job.title }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <select class="form-select" id="applicationStatusFilter">
                                    <option value="">All Statuses</option>
                                    <option value="pending">Pending</option>
                                    <option value="under_review">Under Review</option>
                                    <option value="interview_scheduled">Interview Scheduled</option>
                                    <option value="accepted">Accepted</option>
                                    <option value="rejected">Rejected</option>
                                    <option value="hired">Hired</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Applicant Name</th>
                                <th>Email</th>
                                <th>Job Position</th>
                                <th>Applied Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="applicationTableBody">
                            {% for application in applications %}
                            <tr>
                                <td>{{ application.applicant_name }}</td>
                                <td>{{ application.applicant_email }}</td>
                                <td>{{ application.job.title }}</td>
                                <td>{{ application.applied_at|date:"Y-m-d" }}</td>
                                <td>
                                    <span class="badge 
                                        {% if application.status == 'pending' %}bg-secondary
                                        {% elif application.status == 'under_review' %}bg-primary
                                        {% elif application.status == 'interview_scheduled' %}bg-info
                                        {% elif application.status == 'accepted' %}bg-success
                                        {% elif application.status == 'rejected' %}bg-danger
                                        {% elif application.status == 'hired' %}bg-success
                                        {% endif %}">
                                        {{ application.status|cut:'_'|title }}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#updateApplicationModal{{ application.id }}">
                                        Update
                                    </button>
                                    <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#createInterviewModal" data-application-id="{{ application.id }}">
                                        Schedule Interview
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Application Update Modals -->
{% for application in applications %}
<div class="modal fade" id="updateApplicationModal{{ application.id }}" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" action="{% url 'employee:application_update' application.id %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Update Application: {{ application.applicant_name }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Applicant Name</label>
                            <input type="text" class="form-control" name="applicant_name" value="{{ application.applicant_name }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Applicant Email</label>
                            <input type="email" class="form-control" name="applicant_email" value="{{ application.applicant_email }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Job</label>
                            <select class="form-select" name="job" required>
                                {% for job in job_posts %}
                                <option value="{{ job.id }}" {% if job.id == application.job.id %}selected{% endif %}>{{ job.title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" name="status" required>
                                <option value="pending" {% if application.status == 'pending' %}selected{% endif %}>Pending</option>
                                <option value="under_review" {% if application.status == 'under_review' %}selected{% endif %}>Under Review</option>
                                <option value="interview_scheduled" {% if application.status == 'interview_scheduled' %}selected{% endif %}>Interview Scheduled</option>
                                <option value="accepted" {% if application.status == 'accepted' %}selected{% endif %}>Accepted</option>
                                <option value="rejected" {% if application.status == 'rejected' %}selected{% endif %}>Rejected</option>
                                <option value="hired" {% if application.status == 'hired' %}selected{% endif %}>Hired</option>
                            </select>
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Cover Letter</label>
                            <textarea class="form-control" name="cover_letter" rows="3">{{ application.cover_letter }}</textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Update Application</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<!-- All Activities Modal -->
<div class="modal fade" id="allActivitiesModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">All Recent Activities</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Role</th>
                                <th>Joined Date</th>
                                <th>Days Ago</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for activity in recent_activities %}
                            <tr>
                                <td>{{ activity.first_name }} {{ activity.last_name }}</td>
                                <td>{{ activity.sub_role|title }}</td>
                                <td>{{ activity.date_joined|date:"Y-m-d" }}</td>
                                <td>{{ activity.date_joined|timesince }} ago</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center">No activities found</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- All Interviews Modal -->
<div class="modal fade" id="allInterviewsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">All Upcoming Interviews</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Applicant</th>
                                <th>Job Position</th>
                                <th>Scheduled Date</th>
                                <th>Interviewer</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for interview in upcoming_interviews %}
                            <tr>
                                <td>{{ interview.application.applicant_name }}</td>
                                <td>{{ interview.application.job.title }}</td>
                                <td>{{ interview.scheduled_date|date:"Y-m-d H:i" }}</td>
                                <td>{{ interview.interviewer.first_name }} {{ interview.interviewer.last_name }}</td>
                                <td>
                                    <span class="badge bg-primary">{{ interview.status|title }}</span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center">No upcoming interviews</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock content %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Applications by Job Post Chart
        const applicationsByJobCtx = document.getElementById('applicationsByJobChart').getContext('2d');
        
        fetch(`{% url 'employee:hr_chart_data' %}?type=applications_by_job`)
            .then(response => response.json())
            .then(data => {
                new Chart(applicationsByJobCtx, {
                    type: 'bar',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            });
        
        // Employee Distribution Chart
        const employeeDistributionCtx = document.getElementById('employeeDistributionChart').getContext('2d');
        
        fetch(`{% url 'employee:hr_chart_data' %}?type=employee_distribution`)
            .then(response => response.json())
            .then(data => {
                new Chart(employeeDistributionCtx, {
                    type: 'pie',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            });
        
        // Calendar navigation
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        const currentMonthElement = document.getElementById('currentMonth');
        const calendarBody = document.getElementById('calendarBody');
        
        let currentMonth = {{ calendar_data.month_name|default:'new Date().getMonth()' }};
        let currentYear = {{ calendar_data.year|default:'new Date().getFullYear()' }};
        
        // This is a simplified version - in a real app, you would fetch calendar data for each month
        prevMonthBtn.addEventListener('click', function() {
            // Implementation would go here
            alert('Previous month functionality would be implemented here');
        });
        
        nextMonthBtn.addEventListener('click', function() {
            // Implementation would go here
            alert('Next month functionality would be implemented here');
        });
        
        // User delete confirmation
        window.confirmDelete = function(userId) {
            if (confirm('Are you sure you want to delete this user?')) {
                window.location.href = `{% url 'employee:user_delete' 0 %}`.replace('0', userId);
            }
        };
        
        // Pass application ID to interview modal
        document.querySelectorAll('[data-application-id]').forEach(button => {
            button.addEventListener('click', function() {
                const applicationId = this.getAttribute('data-application-id');
                const interviewModal = document.getElementById('createInterviewModal');
                const applicationSelect = interviewModal.querySelector('#interviewApplication');
                
                // Set the selected application
                applicationSelect.value = applicationId;
                
                // Show the modal
                const modal = new bootstrap.Modal(interviewModal);
                modal.show();
            });
        });
    });
</script>
{% endblock extra_js %}